{% extends "layout.html" %}


{% block body %}
<div class="px-7">
  <div id="map" style="height: 180px;"></div>
  <div class="stats shadow bg-error">
    <div class="stat">
      <div class="stat-title">No. of SOS Alerts!</div>
      <div class="stat-value" id="sos-count"></div>
    </div>
  </div>
  <div id="toastContainer" class="toast toast-end fixed top-5 right-5 flex flex-col mt-6"></div>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    // Create a single supabase client for interacting with your database
    const supabase = createClient('https://ljncaafiuqjlrnruxirq.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxqbmNhYWZpdXFqbHJucnV4aXJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzkzNjE1ODMsImV4cCI6MjA1NDkzNzU4M30.p66vJW72EXOPI7khL1Nb8_qwv-W-DnU_Pk0UH_uBMGc')
    function showAlert(message) {
      const toast = document.createElement("div");
      toast.classList.add("toast", "toast-end");
      toast.innerHTML = `
      <div class="alert alert-warning">
        <span>${message}</span>
      </div>
      `;
      document.getElementById('toastContainer').appendChild(toast);
      setTimeout(() => toast.remove(), 6000);
    }
    var map = L.map('map').setView([15.20, 78.6413], 13);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);
    async function start() {
      let { data, count, error } = await supabase
        .from('SOS Alerts')
        .select('*', { count: 'exact' });

      if (error) {
        console.error("Error fetching row count:", error);
      } else {
        document.getElementById('sos-count').textContent = count;
        data.forEach(row => {
          console.log(row.latitude)
          var marker = L.marker([parseFloat(row.latitude), parseFloat(row.longitude)]).addTo(map);

        });
      }
    }

    async function run() {

      const changes = supabase.channel('custom-insert-channel')
        .on(
          'postgres_changes',
          { event: 'INSERT', schema: 'public', table: 'SOSAlerts' },
          (payload) => {
            if (payload.eventType === 'INSERT') {
              console.log(payload)
              showAlert(`${payload.new.UserName} has sent an SOS`);
            }
          }
        )
        .subscribe()
    }
    run()

  </script>
</div>
{% endblock %}